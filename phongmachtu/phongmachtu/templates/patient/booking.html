{% extends 'layout/base.html' %}

{% block title %}Đặt lịch khám{% endblock %}

{% block content %}

<header>
    <link href="{{ url_for('static', filename='css/styles.css') }}" rel="stylesheet"/>
</header>

{% if current_user.is_authenticated and current_user.type=="patient" %}
<section class="appointment-section mt-5" style="margin-bottom: 100px">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-6 col-lg-5 shadow-lg rounded-3 bg-light p-4 border border-2">
                <h1 class="text-center text-primary mb-4">Đặt Lịch Khám</h1>

                {% if err_msg %}
                <div class="alert alert-danger">{{ err_msg }}</div>
                {% endif %}

                {% if success_msg %}
                <div class="alert alert-success">{{ success_msg }}</div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data">

                    <div class="form-group mb-4">
                        <label for="ngayKham" class="form-label">Ngày khám:</label>
                        <input type="date" class="form-control rounded-pill" id="ngayKham" name="date"
                               placeholder="Chọn ngày khám" required>
                        <div id="feedback-date" class="invalid-feedback" style="display: none;">Nhập ngày phù hợp</div>
                    </div>

                    <div class="form-group mb-4">
                        <label for="buoiKham" class="form-label">Chọn buổi khám:</label>
                        <select class="form-select rounded-pill" id="buoiKham" aria-label="Chọn buổi khám" name="time">
                            {% for t in time %}
                            <option value="{{ t.id }}">{{ t.period }}</option>
                            {% endfor %}
                        </select>
                        <div id="feedback-time" class="invalid-feedback" style="display: none;">Nhập buổi phù hợp</div>
                    </div>


                    <div class="form-group mb-4">
                        <label for="trieuchung" class="form-label">Triệu chứng:</label>
                        <textarea class="form-control rounded-3" id="trieuchung" name="symptom"
                                  placeholder="Triệu chứng" rows="3"></textarea>
                    </div>

                    <button type="submit" class="btn btn-primary btn-lg rounded-pill w-100">Xác nhận</button>
                </form>
            </div>
        </div>
    </div>
</section>

{% else %}
<div class="container mt-5 text-center">
    <div class="text-center mb-4">
        <h1 class="fw-bold text-primary"><a href="/login" class="text-decoration-none text-primary">ĐĂNG NHẬP ĐỂ ĐẶT
            LỊCH</a></h1>
    </div>
</div>
{% endif %}
<script>
    let isFormValid = true;

    document.getElementById('ngayKham').addEventListener('input', function () {
        console.log('Ngày khám được nhập:', this.value);
        checkDateAndTime(this.value, document.getElementById('buoiKham').value);
    });

    document.getElementById('buoiKham').addEventListener('change', function () {
        console.log('Buổi khám được chọn:', this.value);

        checkDateAndTime(document.getElementById('ngayKham').value, this.value);
    });

    function checkDateAndTime(date, time) {
        const feedback_date = document.getElementById('feedback-date');
        const feedback_time = document.getElementById('feedback-time');
        const currentDate = new Date();
        const currentHour = currentDate.getHours();
        const today = currentDate.toISOString().split('T')[0];

        feedback_date.style.display = 'none';
        feedback_time.style.display = 'none';
        isFormValid = true;

        if (date < today) {
            feedback_date.innerText = "Chọn ngày hợp lệ";
            feedback_date.style.display = 'block';
            isFormValid = false;
            return;
        }

        if (date === today) {
            if (time === '1' && currentHour > 11) {
                feedback_time.innerText = "Không thể chọn buổi sáng sau 11 giờ.";
                feedback_time.style.display = 'block';
                isFormValid = false;
            } else if (time === '2' && currentHour > 17) {
                feedback_time.innerText = "Không thể chọn buổi chiều sau 17 giờ.";
                feedback_time.style.display = 'block';
                isFormValid = false;
            }
        }




        if (!date) {
            feedback_date.innerText = "Vui lòng chọn ngày khám.";
            feedback_date.style.display = 'block';
            isFormValid = false;
        }
        if (!time) {
            feedback_time.innerText = "Vui lòng chọn buổi khám.";
            feedback_time.style.display = 'block';
            isFormValid = false;
        }
    }

    document.querySelector('form').addEventListener('submit', function (event) {
        if (!isFormValid) {
            event.preventDefault(); // Ngăn form gửi đi nếu dữ liệu không hợp lệ
            alert('Vui lòng sửa thông tin không hợp lệ trước khi gửi.');
        }
    });

</script>

{% endblock %}
